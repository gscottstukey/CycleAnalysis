{% extends "base.html" %}
{% block content %}

    <style>
      #map-canvas {text-align: center;}
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&signed_in=true"></script>
    <script type="text/javascript" src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization','version':'1.1','packages':['corechart']}]}"></script>

<script>
var line;

function initialize() {
  getActivity('{{athlete.activities[0].id}}', '{{athlete.userid}}', '#activity{{ athlete.activities[0].id }}');
}

function setMap(a) {

  console.log(a.latitude);
  console.log(a.longitude);
  console.log(a.center);

  var mapOptions = {
    mapTypeId: google.maps.MapTypeId.TERRAIN
  };

  var map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);

  var coords = [];

  for (var i = 0; i < a.latitude.length; i++) {
    coords.push(new google.maps.LatLng(a.latitude[i], a.longitude[i]));
  }

  var lineSymbol = {
    path: google.maps.SymbolPath.CIRCLE,
    scale: 8,
    strokeColor: '#000'
  };

  var lineSymbolA = {
    path: google.maps.SymbolPath.CIRCLE,
    scale: 8,
    strokeColor: '#393'
  };

  line = new google.maps.Polyline({
    path: coords,
    strokeColor: '#1da1cc',
    icons: [{
      icon: lineSymbol,
      offset: '100%'
    },
    {
      icon: lineSymbolA,
      offset: '100%'
    }],
    map: map
  });

  var sw = new google.maps.LatLng(a['center'][0][0], a['center'][0][1])
  var ne = new google.maps.LatLng(a['center'][1][0], a['center'][1][1])
  var bounds = new google.maps.LatLngBounds(sw, ne)
  map.fitBounds(bounds);

}

google.load('visualization', '1.0', {'packages':['corechart']});

function zip(arrays) {
    return arrays[0].map(function(_,i){
        return arrays.map(function(array){return array[i]})
    });
}
function lineChart(a) {
    data = zip([a.distance, a.altitude]);
    var ymin = Math.min.apply(null, a.altitude)
    var ymax = Math.max.apply(null, a.altitude)
        chart = new Highcharts.Chart({
            chart: {
                renderTo: 'container'
            },
            xAxis: {
                title: {
                    enabled: true,
                    text: 'Distance (mi)'
                },
                ordinal: false
            },
            yAxis: {
              min: ymin,
              max: ymax,
                title: {
                    text: 'Altitude (ft)'
                }
            },
            plotOptions: {
                area: {
                    fillColor: {
                        linearGradient: { x1: 0, y1: 0, x2: 0, y2: 1},
                        stops: [
                            [0, Highcharts.getOptions().colors[0]],
                            [1, Highcharts.Color(Highcharts.getOptions().colors[0]).setOpacity(0).get('rgba')]
                        ]
                    },

                }
            },
            title: {
                text: 'Ride profile'
            },
            series: [
            {
              type: 'area',
              name: 'Altitude',
              data: data,
              lineWidth: 3,
                marker: {
                    enabled: false,
                    radius: 0,
                    states: {
                        hover: {
                            enabled: true,
                            lineColor: 'rgb(100,100,100)'
                        }
                    }
                }
            },
            {
              type: 'line',
              name: 'Actual',
              data: [[0, 0], [0, 10000]]
            },
            {
              type: 'line',
              name: 'Predicted',
              data: [[0, 0], [0, 10000]]
            }]
        });
};

function simRide(a) {
    document.getElementById("ride-console").style.visibility = "visible";
    var count = 0;
    d = a['distance'];
    pd = a['predicted_distance'];
    total_distance = d[d.length - 1];
    var duration = moment.duration(0, 'seconds');

    simInterval = window.setInterval(function() {
      count = count + 10;
      if (count >= d.length) {
        clearInterval(simInterval)
      }
      else {

        var icons = line.get('icons');
        icons[0].offset = d[count]*100.0/total_distance + '%';
        icons[1].offset = pd[count]*100.0/total_distance + '%';
        line.set('icons', icons);
        duration = moment.duration(a.time[count]*1000, 'seconds');
        chart.series[1].setData([[a.distance[count], 0], [a.distance[count], 10000]]);
        chart.series[2].setData([[a.predicted_distance[count], 0], [a.predicted_distance[count], 10000]]);

        document.getElementById('playback-timer').innerHTML = moment.utc(a.time[count]*1000).format("HH:mm")
        document.getElementById('playback-margin').innerHTML = (d[count] - pd[count]).toFixed(2);
        document.getElementById('playback-distance').innerHTML = d[count].toFixed(2);
      }
  }, 50);
}

function getActivity(aid, uid, activityElement) {
  $.post('/change', {
        activity_id: aid,
        athlete_id: uid
    }).done(function(response){
      switchActivity(response)
    }).fail(function() {
        console.log('fail');
    });
}

function switchActivity(a) {
  activity = a
  $(document.getElementById('activity_desc')).text(a['name']);
  $(document.getElementById('activity_date')).text(a['date']);
  $(document.getElementById('activity_rating')).text(a['ride_rating'][1]);
  $(document.getElementById('activity_start')).text(a['start_time']);
  $(document.getElementById('activity_moving_time')).text(a['moving_time']);
  $(document.getElementById('activity_pred_time')).text(a['predicted_total_time']);
  if (typeof simInterval !== 'undefined') {
    clearInterval(simInterval)
  }
  if (typeof chartInterval !== 'undefined') {
    clearInterval(chartInterval)
  }
  setMap(a)
  lineChart(a)
}

      google.maps.event.addDomListener(window, 'load', initialize);

    </script>
    <style type="text/css">
      .map { margin: 0 auto 0 auto; }
      .wrapper {text-align: center;
                padding: 5px 5px 5px 5px;
               }
    </style>
    <div class="row">
    <div class='span6 main' style="margin-left: 52px;">

      <table>
        <thead><th colspan="2">Ride Summary</th></thead>
        <tr><td>Rider:</td><td>{{athlete.name}}</td></tr>
        <tr><td>Ride:</td><td><span id="activity_desc">{{activity.name}}</span></td></tr>
        <tr><td>Date:</td><td><span id="activity_date">{{activity.dt.strftime("%A %B %d, %Y")}}</span></td></tr>
        <tr><td>Start Time:</td><td><span id="activity_start">{{activity.dt.strftime("%H:%M:%S %p")}}</span></td></tr>
        <tr><td>Total Time:</td><td><span id="activity_moving_time">{{activity.moving_time_string}}</span></td></tr>
        <tr><td>Predicted Time:</td><td><span id="activity_pred_time">{{activity.predicted_moving_time}}</span></td></tr>
        <tr><td>Ride Rating:</td><td><span id="activity_rating"></span></td></tr>
      </table>
      <div class="wrapper">
          <button id="play" onclick="simRide(activity)">Play Ride</button>
      </div>
      <div id="ride-console" style="visibility: hidden;">
        <table>
          <tr>
            <td>Time elapsed:</td> <td id="playback-timer"></td>
            <td>Distance:</td> <td id="playback-distance"></td>
            <td>Margin:</td> <td id="playback-margin"></td>
          </tr>
        </table>
      </div>
      <div class="map" id="map-canvas" style="width:500px;height:380px;"></div>
      <div id="container" style="min-width: 310px; height: 400px; max-width: 800px; margin: 0 auto"></div>
    </div>
      <div class='span2 main'></div>
      <div class='span6 main'>
      <form enctype="multipart/form-data" action="/upload/image" method="post">
          <input id="image-file" type="file" />
      </form>
      <table align="right">
        <thead>
          <th>Rating</th>
          <th>Ride Name</th>
          <th>Date</th>
          <th>Distance</th>
          <th>Start</th>
        </thead>
      {% for a in athlete.activities %}
      <tr>
        <td></td>
        <td><a href="javascript:getActivity({{a.id}}, {{athlete.userid}}, '#activity{{ a.id }}');">{{a.name}}</a></td>
        <td>{{a.dt.strftime("%B %d, %Y")}}</td>
        <td>{{(a.total_distance / 1609.34)|round(0, 'floor')}}</td>
        <td>{{a.dt.strftime("%I:%M:%S %p")}}</td>
      </tr>
      {% endfor %}
    </table>
  </div>
</div>
<script type="text/javascript" src="https://www.google.com/jsapi?autoload={'modules':[{'name':'visualization','version':'1.1','packages':['corechart']}]}"></script>

    <script type="text/javascript" charset="utf-8">
      $(document).ready(function() {
        $("table").tablecloth({
          theme: "stats",
          striped: true,
          sortable: true,
          condensed: true,
          clean: true
        });
      });
    </script>
  <!-- </body> -->


{% endblock %}
{% extends "base.html" %}
{% block content %}

<script>
function addAthlete(){
	document.getElementById("add-athlete").style.visibility = "visible";
}

function getData(uid){
    console.log(uid)
  document.getElementById("new-user-status").innerHTML = "We're loading your data right now. This will take a moment";
  document.getElementById("new-user-status").style.visibility = "visible";
  $.post('/get-data', {
    userid: uid
  }).done(function(response){
    document.getElementById("new-user-status").innerHTML = "We loaded your activities for you!"
    trainModel(uid);
  }).fail(function(){
      document.getElementById('new-user-status').innerHTML = 'Something went wrong! Ugh.';
      console.log('fail')
  });
}

function trainModel(uid){
  document.getElementById("new-user-status").innerHTML = "We've got your data. Now we're customizing a model just for you. This may take a minute too!";
  document.getElementById("new-user-status").style.visibility = "visible";
  $.post('/fit', {
    userid: uid
  }).done(function(response){
    document.getElementById("new-user-status").innerHTML = "Model complete!"
    window.location.href = "/rides/" + uid
  }).fail(function(){
      document.getElementById('new-user-status').innerHTML = 'Something went wrong! Ugh.';
      console.log('fail')
  });
}

function checkUser(uid) {
  console.log(uid)
    $.post('/check', {
      userid: uid
    }).done(function(response) {
        console.log(response)
        if (response === "new") {
          // show new user stuff
          document.getElementById("new-user").innerHTML = "Whoa, you're new here. Welcome to the site! We need to do a few things to get you started.";
          document.getElementById("new-user").style.visibility = "visible";
          getData(uid);
        }
        else if (response === 'predict'){
          document.getElementById("new-user-status").innerHTML = "We've got your data, but we need to train a model on it!"
          document.getElementById("new-user").style.visibility = "visible";
          trainModel(uid);
        }
        else {
          window.location.href = "/rides/" + uid
        }
    }).fail(function() {
      document.getElementById('new-user').innerHTML = 'Something went wrong! Ugh.';
        console.log('fail');
    });
}
</script>

<div class='span2 main'></div>
<div class='span6 main'>
<h3>Current Athletes</h3>
<table>
	<thead>
		<th>Athlete</th>
		<th>Location</th>
		<th></th>
	</thead>
{% for athlete in athletes %}
<tr>
	<td>{{athlete['firstname'] + ' ' + athlete['lastname']}}</td>
	<td>{{athlete['city'] + ', ' + athlete['state']}}</td>
	<!-- <td><a href="{{url_for('rides', userid=athlete['id'])}}">View my rides</a></td> -->
  <td><a id="rides{{athlete['id']}}" onclick="checkUser({{athlete['id']}})">View my rides</a></td>
</tr>
{% endfor %}
</table>

<div id="new-user" style="visibility: hidden; margin-left=10px;"></div>
</br>
<div id="new-user-status" style="visibility: hidden; margin-left=10px;"></div>
</br>
<p>Don't see yourself?</p>
<a href="https://www.strava.com/oauth/authorize?client_id=4554&response_type=code&redirect_uri=http://hendris.pythonanywhere.com/token_exchange&approval_prompt=force">
<img src="static/img/ConnectWithStrava.png">
</a>
</div>
</div>
<script type="text/javascript" charset="utf-8">
      $(document).ready(function() {
        $("table").tablecloth({
          theme: "stats",
          striped: true,
          sortable: true,
          condensed: true,
          clean: true
        });
      });
    </script>
{% endblock %}